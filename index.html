<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live API ê²½ì œ ì§€í‘œ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; color: #212529; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .header { text-align: center; border-bottom: 2px solid #dee2e6; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #0056b3; margin: 0; }
        .header p { margin: 5px 0 0; color: #6c757d; }
        .section-title { font-size: 1.8em; color: #17a2b8; margin-top: 40px; margin-bottom: 20px; border-left: 5px solid #17a2b8; padding-left: 10px; }
        #outlook-section { text-align: center; padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 1px solid; }
        .outlook-signal { font-size: 3em; margin-bottom: 10px; }
        .outlook-title { font-size: 1.8em; font-weight: bold; margin: 0; }
        
        /* Sector Outlook Styles */
        #sector-outlook-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .sector-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; }
        .sector-title { font-size: 1.4em; color: #343a40; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; }
        .sector-icon { font-size: 1.5em; margin-right: 10px; }
        .sector-outlook { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .sector-reason { font-size: 0.95em; color: #6c757d; }

        /* Compact Indicator Card Styles */
        .indicator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; }
        .indicator-card { background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; flex-direction: column; justify-content: space-between; }
        .indicator-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .indicator-card h4 { margin: 0; color: #343a40; font-size: 1.05em; line-height: 1.3; }
        .indicator-card .date { font-size: 0.75em; color: #6c757d; font-weight: normal; }
        .indicator-value { font-size: 1.8em; font-weight: bold; margin: 8px 0; color: #007bff; }
        .indicator-status { display: flex; align-items: center; font-weight: bold; font-size: 0.95em; }
        .status-icon { font-size: 1.3em; margin-right: 6px; }
        .card-footer { display: flex; justify-content: flex-end; align-items: center; margin-top: 10px; }
        .details-btn { background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.75em; }
        .impact-ratio { font-size: 0.75em; font-weight: bold; color: #fff; background-color: #17a2b8; padding: 2px 7px; border-radius: 10px; margin-right: 10px; }
        
        .analysis-section p { font-size: 1.1em; background-color: #e9ecef; padding: 20px; border-radius: 8px; border-left: 5px solid #6c757d; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d; }
        .positive-bg { background-color: #d4edda; border-color: #c3e6cb; } .positive-text { color: #155724; } .positive-icon { color: #28a745; }
        .negative-bg { background-color: #f8d7da; border-color: #f5c6cb; } .negative-text { color: #721c24; } .negative-icon { color: #dc3545; }
        .neutral-bg { background-color: #fff3cd; border-color: #ffeeba; } .neutral-text { color: #856404; } .neutral-icon { color: #ffc107; }
        .loading-text { color: #6c757d; font-style: italic; font-size: 1.2em; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px; position: relative; animation-name: animatetop; animation-duration: 0.4s }
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
        #modal-title { color: #0056b3; margin-top: 0; }
        #modal-criteria { list-style-type: none; padding-left: 0; }
        #modal-criteria li { background-color: #f1f1f1; margin-bottom: 8px; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>Live API ê²½ì œ ì§€í‘œ ëŒ€ì‹œë³´ë“œ</h1><p id="update-time">ë°ì´í„° ë¡œë”© ì¤‘...</p></header>
        <h2 class="section-title">ì‹œì¥ ì¢…í•© ì „ë§</h2><div id="outlook-section"><p class="loading-text">ì§€í‘œ ë¶„ì„ ì¤‘...</p></div>
        <h2 class="section-title">ì„¹í„°ë³„ ì „ë§</h2><div id="sector-outlook-grid"></div>
        <h2 class="section-title">í•µì‹¬ ì§€í‘œ ëŒ€ì‹œë³´ë“œ</h2><div id="indicator-grid" class="indicator-grid"></div>
        <h2 class="section-title">ì¢…í•© ë¶„ì„ ë° í•´ì„</h2><div id="analysis-section" class="analysis-section"></div>
        <footer class="footer"><p>ë³¸ í˜ì´ì§€ì˜ ë°ì´í„°ëŠ” FRED, í•œêµ­ì€í–‰ ECOS APIë¥¼ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.</p><p>ëª¨ë“  íˆ¬ìì˜ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p></footer>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-description"></p>
            <h4>ëŒ€ì‹œë³´ë“œ íŒë‹¨ ê¸°ì¤€:</h4>
            <ul id="modal-criteria"></ul>
        </div>
    </div>

<script>
// ==================================================================
const API_KEYS = {
    FRED: '480b8d74e3d546674e8180193c30dbf6',
    ECOS: 'C4UHXGGIUUZ1TNZJOXFM'
};
// ==================================================================

const indicatorDetails = { // ... (ì´ì „ê³¼ ë™ì¼, ìƒëµ)
};

document.addEventListener('DOMContentLoaded', main);

async function main() {
    if (API_KEYS.FRED.includes('ì—¬ê¸°ì—') || API_KEYS.ECOS.includes('ì—¬ê¸°ì—')) {
        alert('JavaScript ì½”ë“œ ìƒë‹¨ì— API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    setupModal();
    renderInitialPlaceholders();

    try {
        const [macroData, sectorData] = await Promise.all([
            fetchAllMacroData(),
            fetchAllSectorData()
        ]);
        
        const allIndicators = [...macroData, ...sectorData];
        const analyzedIndicators = analyzeIndicators(allIndicators);
        
        const marketOutlook = getMarketOutlook(analyzedIndicators);
        const sectorOutlook = getSectorOutlook(analyzedIndicators);

        renderDashboard(analyzedIndicators, marketOutlook, sectorOutlook);

    } catch (error) {
        console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
        document.getElementById('update-time').innerText = "ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
    }
}

async function fetchAllMacroData() {
    const [yieldData, additionalFredData, koreanIndicators] = await Promise.all([
        fetchYieldSpread(),
        fetchAdditionalFredData(),
        fetchAllKoreanData()
    ]);
    return [...yieldData, ...additionalFredData, ...koreanIndicators];
}

async function fetchAllSectorData() {
    const series = {
        sox: 'SOX', // í•„ë¼ë¸í”¼ì•„ ë°˜ë„ì²´ ì§€ìˆ˜
        drg: 'DRG', // NYSE ì œì•½ ì§€ìˆ˜
        auto_sales: 'TOTALSA' // ë¯¸êµ­ ì´ ìë™ì°¨ íŒë§¤ëŸ‰
    };
    
    const urls = Object.values(series).map(id => `https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${API_KEYS.FRED}&file_type=json&sort_order=desc&limit=1`);
    const [soxData, drgData, autoData] = await Promise.all(urls.map(url => fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(url)}`).then(res => res.json())));
    
    const format = (data, id, name, unit) => {
        const obs = data.observations?.[0];
        return { id, name, value: obs ? parseFloat(obs.value) : 'N/A', unit, date: obs ? obs.date.substring(5) : 'ì—†ìŒ' };
    };
    return [
        format(soxData, 'sox_index', 'âš¡ï¸ í•„ë¼ë¸í”¼ì•„ ë°˜ë„ì²´ ì§€ìˆ˜', ''),
        format(autoData, 'auto_sales', 'ğŸš— ç¾ ìë™ì°¨ íŒë§¤ëŸ‰', 'M'),
        format(drgData, 'pharma_index', 'ğŸ’Š NYSE ì œì•½ ì§€ìˆ˜', '')
    ];
}


// ... (fetchYieldSpread, fetchAdditionalFredData, fetchAllKoreanData í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼)

function analyzeIndicators(indicators) {
    const weights = {
        // ê±°ì‹œ ê²½ì œ ì§€í‘œ
        yield_spread: 15, vix: 15, gdp_growth: 10, export_growth: 10, industrial_production: 8,
        corp_bond_spread: 8, cpi: 7, dollar_index: 6, wti_price: 5, consumer_sentiment: 5,
        base_rate: 4, unemployment: 4, exchange_rate: 3, producer_price_index: 2, kospi: 0,
        // ì„¹í„° ì§€í‘œ (ì‹œì¥ ì „ì²´ ì „ë§ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ)
        sox_index: 0, auto_sales: 0, pharma_index: 0 
    };
    // ... (ì´í•˜ ë¶„ì„ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼)
}

function getMarketOutlook(analyzedIndicators) {
    // ... (ì´ì „ê³¼ ë™ì¼)
}

function getSectorOutlook(analyzedIndicators) {
    const find = (id) => analyzedIndicators.find(i => i.id === id) || {};

    // 1. ì „ê¸°/ì „ì (ë°˜ë„ì²´) ì „ë§
    const sox = find('sox_index');
    const exchange_rate = find('exchange_rate');
    let electronicsOutlook = { status: 'neutral', text: 'ì¤‘ë¦½ì ', reason: 'ê¸€ë¡œë²Œ ìˆ˜ìš”ì™€ í™˜ìœ¨ íš¨ê³¼ê°€ í˜¼ì¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'};
    if (sox.score > 0 && exchange_rate.score < 0) { // ì§€ìˆ˜ ìƒìŠ¹ & ì›í™” ê°•ì„¸
        electronicsOutlook = { status: 'neutral', text: 'ì¤‘ë¦½ì ', reason: 'ë°˜ë„ì²´ ì—…í™©ì€ ê¸ì •ì ì´ë‚˜, ì›í™” ê°•ì„¸ê°€ ìˆ˜ì¶œ ê¸°ì—…ì˜ ìˆ˜ìµì„±ì„ ì¼ë¶€ ìƒì‡„í•©ë‹ˆë‹¤.'};
    } else if (sox.score > 0 && exchange_rate.score >= 0) { // ì§€ìˆ˜ ìƒìŠ¹ & ì›í™” ì•½ì„¸/ë³´í•©
        electronicsOutlook = { status: 'positive', text: 'ê¸ì •ì ', reason: 'ë°˜ë„ì²´ ì—…í™© ê°œì„ ê³¼ ìš°í˜¸ì ì¸ í™˜ìœ¨ í™˜ê²½ìœ¼ë¡œ ì‹¤ì  ê°œì„  ê¸°ëŒ€ê°ì´ ë†’ìŠµë‹ˆë‹¤.'};
    } else if (sox.score < 0) { // ì§€ìˆ˜ í•˜ë½
        electronicsOutlook = { status: 'negative', text: 'ë¶€ì •ì ', reason: 'ê¸€ë¡œë²Œ ë°˜ë„ì²´ ìˆ˜ìš” ë‘”í™” ìš°ë ¤ê°€ ì»¤ì§€ê³  ìˆìŠµë‹ˆë‹¤.'};
    }

    // 2. ìë™ì°¨ ì „ë§
    const auto = find('auto_sales');
    const wti = find('wti_price');
    let autoOutlook = { status: 'neutral', text: 'ì¤‘ë¦½ì ', reason: 'íŒë§¤ëŸ‰ê³¼ ìœ ê°€ ë³€ë™ì„ ì£¼ì‹œí•´ì•¼ í•©ë‹ˆë‹¤.'};
    if (auto.score > 0 && wti.score > 0) { // íŒë§¤ëŸ‰ ì¦ê°€ & ìœ ê°€ ì•ˆì •
        autoOutlook = { status: 'positive', text: 'ê¸ì •ì ', reason: 'ê²¬ì¡°í•œ íŒë§¤ëŸ‰ê³¼ ìœ ê°€ ì•ˆì •ìœ¼ë¡œ ì†Œë¹„ ì‹¬ë¦¬ê°€ ê°œì„ ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.'};
    } else if (auto.score < 0) { // íŒë§¤ëŸ‰ ê°ì†Œ
         autoOutlook = { status: 'negative', text: 'ë¶€ì •ì ', reason: 'ìë™ì°¨ ìˆ˜ìš” ë‘”í™” ì‹œê·¸ë„ì´ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.'};
    } else if (wti.score < 0) { // ìœ ê°€ ê¸‰ë“±
        autoOutlook = { status: 'neutral', text: 'ì¤‘ë¦½ì ', reason: 'íŒë§¤ëŸ‰ì€ ì–‘í˜¸í•˜ë‚˜, ê³ ìœ ê°€ê°€ ì†Œë¹„ìì˜ êµ¬ë§¤ ë¶€ë‹´ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'};
    }

    // 3. ì˜ì•½/ë°”ì´ì˜¤ ì „ë§
    const pharma = find('pharma_index');
    const vix = find('vix');
    let pharmaOutlook = { status: 'neutral', text: 'ì¤‘ë¦½ì ', reason: 'ê²½ê¸° ë°©ì–´ì  ì„±ê²©ê³¼ ì„±ì¥ ê¸°ëŒ€ê°ì´ ê³µì¡´í•©ë‹ˆë‹¤.'};
    if (vix.score < 0) { // ì‹œì¥ ë¶ˆì•ˆ (VIX ìƒìŠ¹)
        pharmaOutlook = { status: 'positive', text: 'ê¸ì •ì ', reason: 'ì‹œì¥ ë³€ë™ì„±ì´ ì»¤ì§ˆ ë•Œ, ê²½ê¸° ë°©ì–´ì£¼ë¡œì„œì˜ ë§¤ë ¥ì´ ë¶€ê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'};
    } else if (pharma.score < 0) {
        pharmaOutlook = { status: 'negative', text: 'ë¶€ì •ì ', reason: 'ì„¹í„° ìì²´ì˜ íˆ¬ì ì‹¬ë¦¬ê°€ ìœ„ì¶•ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'};
    }

    return { electronics: electronicsOutlook, auto: autoOutlook, pharma: pharmaOutlook };
}


function renderDashboard(analyzedIndicators, marketOutlook, sectorOutlook) {
    document.getElementById('update-time').innerText = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;
    
    // ì‹œì¥ ì¢…í•© ì „ë§ ë Œë”ë§
    const outlookSection = document.getElementById('outlook-section');
    outlookSection.className = `${marketOutlook.status}-bg`;
    outlookSection.innerHTML = `<div class="outlook-signal">${marketOutlook.signal}</div><h3 class="outlook-title ${marketOutlook.status}-text">${marketOutlook.title}</h3>`;

    // ì„¹í„°ë³„ ì „ë§ ë Œë”ë§
    const sectorGrid = document.getElementById('sector-outlook-grid');
    sectorGrid.innerHTML = `
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">âš¡ï¸</span>ì „ê¸°/ì „ì</h4>
            <p class="sector-outlook ${sectorOutlook.electronics.status}-text">${sectorOutlook.electronics.text}</p>
            <p class="sector-reason">${sectorOutlook.electronics.reason}</p>
        </div>
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">ğŸš—</span>ìë™ì°¨</h4>
            <p class="sector-outlook ${sectorOutlook.auto.status}-text">${sectorOutlook.auto.text}</p>
            <p class="sector-reason">${sectorOutlook.auto.reason}</p>
        </div>
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">ğŸ’Š</span>ì˜ì•½/ë°”ì´ì˜¤</h4>
            <p class="sector-outlook ${sectorOutlook.pharma.status}-text">${sectorOutlook.pharma.text}</p>
            <p class="sector-reason">${sectorOutlook.pharma.reason}</p>
        </div>
    `;

    // í•µì‹¬ ì§€í‘œ ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    const indicatorGrid = document.getElementById('indicator-grid');
    indicatorGrid.innerHTML = '';
    
    const totalWeight = analyzedIndicators.reduce((sum, ind) => sum + (ind.weight > 0 ? ind.weight : 0), 0);
    analyzedIndicators.sort((a, b) => (b.weight || 0) - (a.weight || 0));
    
    analyzedIndicators.forEach(indicator => {
        if (!indicator.id) return;
        const impactRatio = totalWeight > 0 && indicator.weight > 0 ? ((indicator.weight / totalWeight) * 100).toFixed(1) : 0;
        
        const card = document.createElement('div');
        card.className = 'indicator-card';
        const valueText = (typeof indicator.value === 'number' && !isNaN(indicator.value)) 
            ? `${indicator.value.toLocaleString()}${indicator.unit || ''}` 
            : `<span class="loading-text">${indicator.value}</span>`;
            
        card.innerHTML = `
            <div>
                <div class="indicator-card-header">
                    <h4>${indicator.name}<br><span class="date">(${indicator.date})</span></h4>
                </div>
                <p class="indicator-value">${valueText}</p>
                <div class="indicator-status">
                    <span class="status-icon">${indicator.icon}</span>
                    <span class="status-text ${indicator.status}-icon">${indicator.text}</span>
                </div>
            </div>
            <div class="card-footer">
                ${impactRatio > 0 ? `<span class="impact-ratio">ì˜í–¥ë ¥ ${impactRatio}%</span>` : ''}
                <button class="details-btn" onclick="showModal('${indicator.id}')">ìì„¸íˆ ë³´ê¸°</button>
            </div>`;
        indicatorGrid.appendChild(card);
    });
    
    document.getElementById('analysis-section').innerHTML = `<p>${marketOutlook.analysis}</p>`;
}

// ... (setupModal, showModal í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼)

</script>
</body>
</html>

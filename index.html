<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live API 경제 지표 대시보드</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; color: #212529; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .header { text-align: center; border-bottom: 2px solid #dee2e6; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #0056b3; margin: 0; }
        .header p { margin: 5px 0 0; color: #6c757d; }
        .section-title { font-size: 1.8em; color: #17a2b8; margin-top: 40px; margin-bottom: 20px; border-left: 5px solid #17a2b8; padding-left: 10px; }
        #outlook-section { text-align: center; padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 1px solid; }
        .outlook-signal { font-size: 3em; margin-bottom: 10px; }
        .outlook-title { font-size: 1.8em; font-weight: bold; margin: 0; }
        .indicator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .indicator-card { background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 150px; }
        .indicator-card h4 { margin-top: 0; color: #343a40; font-size: 1.2em; display: flex; justify-content: space-between; }
        .indicator-card .date { font-size: 0.8em; color: #6c757d; font-weight: normal; }
        .indicator-value { font-size: 2.2em; font-weight: bold; margin: 10px 0; color: #007bff; }
        .indicator-status { display: flex; align-items: center; font-weight: bold; font-size: 1.1em; }
        .status-icon { font-size: 1.5em; margin-right: 8px; }
        .analysis-section p { font-size: 1.1em; background-color: #e9ecef; padding: 20px; border-radius: 8px; border-left: 5px solid #6c757d; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d; }
        .positive-bg { background-color: #d4edda; border-color: #c3e6cb; } .positive-text { color: #155724; } .positive-icon { color: #28a745; }
        .negative-bg { background-color: #f8d7da; border-color: #f5c6cb; } .negative-text { color: #721c24; } .negative-icon { color: #dc3545; }
        .neutral-bg { background-color: #fff3cd; border-color: #ffeeba; } .neutral-text { color: #856404; } .neutral-icon { color: #ffc107; }
        .loading-text { color: #6c757d; font-style: italic; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>Live API 경제 지표 대시보드</h1><p id="update-time">데이터 로딩 중...</p></header>
        <h2 class="section-title">시장 종합 전망</h2><div id="outlook-section"><p class="loading-text">지표 분석 중...</p></div>
        <h2 class="section-title">핵심 지표 대시보드</h2><div id="indicator-grid" class="indicator-grid"></div>
        <h2 class="section-title">종합 분석 및 해석</h2><div id="analysis-section" class="analysis-section"></div>
        <footer class="footer"><p>본 페이지의 데이터는 FRED, 한국은행 ECOS API를 통해 실시간으로 제공됩니다.</p><p>모든 투자의 책임은 투자자 본인에게 있습니다.</p></footer>
    </div>

<script>
// ==================================================================
// ▼ ▼ ▼ ▼ ▼ 여기에 발급받은 API 키를 입력하세요 ▼ ▼ ▼ ▼ ▼
// ==================================================================
const API_KEYS = {
    FRED: '480b8d74e3d546674e8180193c30dbf6',      // 미국 데이터용
    ECOS: 'C4UHXGGIUUZ1TNZJOXFM' // 한국 데이터용
};
// ==================================================================

document.addEventListener('DOMContentLoaded', main);

document.addEventListener('DOMContentLoaded', main);

async function main() {
    if (API_KEYS.FRED.includes('여기에') || API_KEYS.ECOS.includes('여기에')) {
        alert('JavaScript 코드 상단에 API 키를 먼저 입력해주세요.');
        return;
    }
    
    renderInitialPlaceholders();

    try {
        // 미국/한국 데이터를 각각 호출합니다.
        const [yieldData, koreanIndicators] = await Promise.all([
            fetchYieldSpread(),
            fetchAllKoreanData()
        ]);
        
        const allIndicators = [yieldData, ...koreanIndicators];
        const analyzedIndicators = analyzeIndicators(allIndicators);
        const marketOutlook = getMarketOutlook(analyzedIndicators);

        renderDashboard(analyzedIndicators, marketOutlook);

    } catch (error) {
        console.error("데이터 로딩 실패:", error);
        document.getElementById('update-time').innerText = "데이터 로딩에 실패했습니다. API 키 또는 네트워크 상태를 확인해주세요.";
    }
}


async function fetchAllData() {
    const promises = [
        fetchYieldSpread(),
        // --- ★★★ ECOS 공식 규칙 최종 코드 ★★★ ---
        // fetchEcosData('이름', '통계표 코드', '주기', '세부 항목 코드') 형식
        fetchEcosData('GDP 성장률', '102Y004', 'Q', '200Y001'),
        fetchEcosData('수출 증가율', '200Y009', 'M', '403Y003'),
        fetchEcosData('소비자물가지수', '901Y001', 'M', '010Y002'),
        fetchEcosData('실업률', '401Y003', 'M', 'I2A00')
        // --- ★★★ 수정 끝 ★★★ ---
    ];
    return await Promise.all(promises);
}

// --- 미국 장단기 금리차 데이터 호출 ---
async function fetchYieldSpread() {
    const fredUrl10Y = `https://api.stlouisfed.org/fred/series/observations?series_id=DGS10&api_key=${API_KEYS.FRED}&file_type=json&sort_order=desc&limit=1`;
    const fredUrl2Y = `https://api.stlouisfed.org/fred/series/observations?series_id=DGS2&api_key=${API_KEYS.FRED}&file_type=json&sort_order=desc&limit=1`;

    const [res10Y, res2Y] = await Promise.all([
        fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(fredUrl10Y)}`),
        fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(fredUrl2Y)}`)
    ]);

    const data10Y = await res10Y.json();
    const data2Y = await res2Y.json();
    
    if (!data10Y.observations || data10Y.observations.length === 0 || !data2Y.observations || data2Y.observations.length === 0) {
        throw new Error("FRED 금리 데이터를 가져오는 데 실패했습니다.");
    }

    const value10Y = parseFloat(data10Y.observations[0].value);
    const value2Y = parseFloat(data2Y.observations[0].value);
    
    return {
        id: "yield_spread", name: "🇺🇸 장단기 금리차",
        value: (value10Y - value2Y).toFixed(2), unit: "%p", date: data10Y.observations[0].date.substring(5)
    };
}

// --- ★★★ 새로워진 한국은행 데이터 호출 함수 ★★★ ---
async function fetchAllKoreanData() {
    const ecosApiUrl = `https://ecos.bok.or.kr/api/KeyStatisticList/${API_KEYS.ECOS}/json/kr/1/100`;
    const finalUrl = `/.netlify/functions/proxy?targetUrl=${encodeURIComponent(ecosApiUrl)}`;
    const response = await fetch(finalUrl);
    const data = await response.json();

    if (!data.KeyStatisticList || !data.KeyStatisticList.row) {
        throw new Error("한국은행 주요지표(KeyStatisticList)를 가져오지 못했습니다.");
    }
    
    const allStats = data.KeyStatisticList.row;

    // --- ★★★ 디버깅 코드 ★★★ ---
    console.log("--- ECOS API 실제 응답 데이터 (100개 지표 전체) ---");
    // 보기 편하도록 표(table) 형식으로 출력합니다.
    console.table(allStats); 

    // 'GDP' 또는 '국내총생산' 키워드를 포함하는 모든 항목을 찾아봅니다.
    const gdpCandidates = allStats.filter(stat => stat.STAT_NAME && (stat.STAT_NAME.includes('GDP') || stat.STAT_NAME.includes('국내총생산')));
    console.log("--- 'GDP' 또는 '국내총생산' 포함 후보 데이터 ---");
    console.table(gdpCandidates);
    // --- ★★★ 디버깅 코드 끝 ★★★ ---

    const gdpData = allStats.find(stat => stat.STAT_NAME && stat.STAT_NAME.includes('실질 국내총생산(전분기대비'));
    const exportData = allStats.find(stat => stat.STAT_NAME && stat.STAT_NAME.includes('수출금액증감률(총, 전년동월대비)'));
    const cpiData = allStats.find(stat => stat.STAT_NAME && stat.STAT_NAME.includes('소비자물가지수(총지수, 전년동월대비'));
    const unemploymentData = allStats.find(stat => stat.STAT_NAME && stat.STAT_NAME.includes('실업률(계절변동조정'));
    
    const formatData = (stat, displayName) => {
        if (!stat) return { id: displayName, name: `🇰🇷 ${displayName}`, value: 'N/A', unit: '', date: '없음' };
        
        let date = stat.CYCLE === '분기' ? `${stat.TIME.slice(0,4)}년 ${stat.TIME.slice(4)}` : `${parseInt(stat.TIME.slice(4))}월`;

        return {
            id: displayName, name: `🇰🇷 ${displayName}`,
            value: parseFloat(stat.DATA_VALUE), unit: stat.UNIT_NAME, date: date
        };
    };

    return [
        formatData(gdpData, 'GDP 성장률'),
        formatData(exportData, '수출 증가율'),
        formatData(cpiData, '소비자물가지수'),
        formatData(unemploymentData, '실업률')
    ];
}
    
// --- 분석 및 렌더링 함수 (수정 없음) ---
function analyzeIndicators(indicators) {
    return indicators.map(indicator => {
        let analysis = {};
        if (typeof indicator.value !== 'number') {
             return { ...indicator, status: 'negative', score: 0, text: '데이터 없음', icon: '❌' };
        }
        switch (indicator.id) {
            case 'yield_spread':
                if (indicator.value < -0.1) analysis = { status: 'negative', score: -2, text: '경기 침체 우려', icon: '🚨' };
                else if (indicator.value < 0) analysis = { status: 'neutral', score: 0, text: '역전폭 축소', icon: '⚠️' };
                else analysis = { status: 'positive', score: 2, text: '정상 범위', icon: '✅' };
                break;
            case 'GDP 성장률':
                if (indicator.value >= 0.7) analysis = { status: 'positive', score: 2, text: '견조한 회복세', icon: '👍' };
                else if (indicator.value >= 0.3) analysis = { status: 'neutral', score: 0, text: '완만한 성장', icon: '😐' };
                else analysis = { status: 'negative', score: -2, text: '성장 둔화 우려', icon: '👎' };
                break;
            case '수출 증가율':
                if (indicator.value > 2.0) analysis = { status: 'positive', score: 2, text: '플러스 전환', icon: '📈' };
                else if (indicator.value >= 0) analysis = { status: 'neutral', score: 0, text: '소폭 개선', icon: '📊' };
                else analysis = { status: 'negative', score: -2, text: '수출 부진', icon: '📉' };
                break;
            case '소비자물가지수':
                if (indicator.value <= 3.0) analysis = { status: 'positive', score: 1, text: '물가 안정세', icon: '😌' };
                else if (indicator.value <= 4.0) analysis = { status: 'neutral', score: 0, text: '인플레이션 둔화', icon: '😐' };
                else analysis = { status: 'negative', score: -1, text: '물가 압력 지속', icon: '🔥' };
                break;
            case '실업률':
                if (indicator.value <= 3.0) analysis = { status: 'positive', score: 1, text: '완전고용 수준', icon: '💪' };
                else analysis = { status: 'negative', score: -1, text: '고용 시장 악화', icon: '😥' };
                break;
            default: analysis = { status: 'neutral', score: 0, text: '데이터 분석 중', icon: '📊' };
        }
        return { ...indicator, ...analysis };
    });
}
function getMarketOutlook(analyzedIndicators) {
    const totalScore = analyzedIndicators.reduce((acc, indicator) => acc + (indicator.score || 0), 0);
    if (totalScore >= 4) return { status: 'positive', signal: '📈', title: '상승 기대', analysis: "대부분의 경제 지표가 긍정적인 신호를 보내고 있습니다. 경기 확장과 물가 안정이 동시에 나타나며 투자 심리가 개선될 가능성이 높습니다." };
    if (totalScore <= -2) return { status: 'negative', signal: '📉', title: '하락 우려', analysis: "경기 침체 또는 둔화에 대한 우려가 커지고 있습니다. 핵심 선행지표가 부정적인 신호를 보내고 있어 보수적인 접근이 필요합니다." };
    return { status: 'neutral', signal: '😐', title: '중립 / 혼조', analysis: "긍정적 요인과 부정적 요인이 혼재되어 시장의 방향성이 불분명합니다. 향후 발표될 기업 실적이나 주요 정책 변화에 따라 시장의 방향이 결정될 가능성이 높습니다." };
}
function renderInitialPlaceholders() {
    const ids = ["🇺🇸 장단기 금리차", "🇰🇷 GDP 성장률", "🇰🇷 수출 증가율", "🇰🇷 소비자물가지수", "🇰🇷 실업률"];
    const grid = document.getElementById('indicator-grid');
    grid.innerHTML = ids.map(name => `<div class="indicator-card"><h4>${name}</h4><p class="loading-text">Loading...</p></div>`).join('');
}
function renderDashboard(analyzedIndicators, marketOutlook) {
    document.getElementById('update-time').innerText = `마지막 업데이트: ${new Date().toLocaleString('ko-KR')}`;
    const outlookSection = document.getElementById('outlook-section');
    outlookSection.className = `${marketOutlook.status}-bg`;
    outlookSection.innerHTML = `<div class="outlook-signal">${marketOutlook.signal}</div><h3 class="outlook-title ${marketOutlook.status}-text">${marketOutlook.title}</h3>`;
    const indicatorGrid = document.getElementById('indicator-grid');
    indicatorGrid.innerHTML = '';
    analyzedIndicators.forEach(indicator => {
        const card = document.createElement('div');
        card.className = 'indicator-card';
        const valueText = typeof indicator.value === 'number' ? `${indicator.value}${indicator.unit}` : `<span class="loading-text">${indicator.value}</span>`;
        card.innerHTML = `
            <h4>${indicator.name} <span class="date">(${indicator.date})</span></h4>
            <p class="indicator-value">${valueText}</p>
            <div class="indicator-status">
                <span class="status-icon">${indicator.icon}</span>
                <span class="status-text ${indicator.status}-icon">${indicator.text}</span>
            </div>`;
        indicatorGrid.appendChild(card);
    });
    document.getElementById('analysis-section').innerHTML = `<p>${marketOutlook.analysis}</p>`;
}

</script>
</body>
</html>

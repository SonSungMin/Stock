<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live API 경제 지표 대시보드</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; color: #212529; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .header { text-align: center; border-bottom: 2px solid #dee2e6; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #0056b3; margin: 0; }
        .header p { margin: 5px 0 0; color: #6c757d; }
        .section-title { font-size: 1.8em; color: #17a2b8; margin-top: 40px; margin-bottom: 20px; border-left: 5px solid #17a2b8; padding-left: 10px; }
        #outlook-section { text-align: center; padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 1px solid; }
        .outlook-signal { font-size: 3em; margin-bottom: 10px; }
        .outlook-title { font-size: 1.8em; font-weight: bold; margin: 0; }
        .outlook-analysis { font-size: 1.1em; margin-top: 15px; padding: 0 20px; }

        /* Sector Outlook Styles */
        #sector-outlook-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .sector-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; }
        .sector-title { font-size: 1.4em; color: #343a40; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; }
        .sector-icon { font-size: 1.5em; margin-right: 10px; }
        .sector-outlook { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .sector-reason { font-size: 0.95em; color: #6c757d; }

        /* Compact Indicator Card Styles */
        .indicator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; }
        .indicator-card { background: #ffffff; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; flex-direction: column; justify-content: space-between; transition: background-color 0.3s ease; }
        .indicator-card.card-negative-bg { background-color: #f8d7da; border-color: #f5c6cb; }
        .indicator-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .indicator-card h4 { margin: 0; color: #343a40; font-size: 1.05em; line-height: 1.3; }
        .indicator-card .date { font-size: 0.75em; color: #6c757d; font-weight: normal; }
        .indicator-value { font-size: 1.8em; font-weight: bold; margin: 8px 0; color: #007bff; }
        .indicator-status { display: flex; align-items: center; font-weight: bold; font-size: 0.95em; }
        .status-icon { font-size: 1.3em; margin-right: 6px; }
        .card-footer { display: flex; justify-content: flex-end; align-items: center; margin-top: 10px; }
        .details-btn { background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.75em; }
        .impact-ratio { font-size: 0.75em; font-weight: bold; color: #fff; background-color: #17a2b8; padding: 2px 7px; border-radius: 10px; margin-right: 10px; }

        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d; }
        .positive-bg { background-color: #d4edda; border-color: #c3e6cb; } .positive-text { color: #155724; } .positive-icon { color: #28a745; }
        .negative-bg { background-color: #f8d7da; border-color: #f5c6cb; } .negative-text { color: #721c24; } .negative-icon { color: #dc3545; }
        .neutral-bg { background-color: #fff3cd; border-color: #ffeeba; } .neutral-text { color: #856404; } .neutral-icon { color: #ffc107; }
        .loading-text { color: #6c757d; font-style: italic; font-size: 1.2em; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px; position: relative; animation-name: animatetop; animation-duration: 0.4s }
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
        #modal-title { color: #0056b3; margin-top: 0; }
        #modal-criteria { list-style-type: none; padding-left: 0; }
        #modal-criteria li { background-color: #f1f1f1; margin-bottom: 8px; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>Live API 경제 지표 대시보드</h1><p id="update-time">데이터 로딩 중...</p></header>
        <h2 class="section-title">시장 종합 전망</h2><div id="outlook-section"><p class="loading-text">지표 분석 중...</p></div>
        <h2 class="section-title">섹터별 전망</h2><div id="sector-outlook-grid"></div>
        <h2 class="section-title">핵심 지표 대시보드</h2><div id="indicator-grid" class="indicator-grid"></div>
        <footer class="footer"><p>본 페이지의 데이터는 FRED, 한국은행 ECOS API를 통해 실시간으로 제공됩니다.</p><p>모든 투자의 책임은 투자자 본인에게 있습니다.</p></footer>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modal-title"></h3>
            <p id="modal-description"></p>
            <h4>대시보드 판단 기준:</h4>
            <ul id="modal-criteria"></ul>
        </div>
    </div>

<script>
// ==================================================================
const API_KEYS = {
    FRED: '480b8d74e3d546674e8180193c30dbf6',
    ECOS: 'C4UHXGGIUUZ1TNZJOXFM'
};
// ==================================================================

const indicatorDetails = {
    yield_spread: {
        title: '🇺🇸 장단기 금리차 (Yield Spread)',
        description: '미래 경기를 예측하는 핵심 선행 지표입니다. 보통 10년 만기 국채 금리에서 2년 만기 국채 금리를 빼서 계산하며, 이 금리차가 마이너스(-)로 떨어지는 \'금리 역전\' 현상은 미래 경기 침체의 강력한 경고 신호로 해석됩니다.',
        criteria: [
            '✅ <b>정상 범위 (0 이상):</b> 경제의 안정적인 확장을 기대하는 상태입니다.',
            '⚠️ <b>역전폭 축소 (-0.1 ~ 0):</b> 경기 침체 우려가 일부 완화되었지만 여전히 불안한 상태입니다.',
            '🚨 <b>경기 침체 우려 (-0.1 미만):</b> 가까운 미래에 경기 침체가 올 가능성이 매우 높다고 시장이 판단하는 상태입니다.'
        ]
    },
    gdp_growth: {
        title: '🇰🇷 GDP 성장률',
        description: '한 나라의 경제 규모가 이전 분기에 비해 얼마나 성장했는지를 보여주는 가장 대표적인 경제 지표입니다. GDP가 꾸준히 성장한다는 것은 국가 경제가 활발하게 움직이고 있다는 의미입니다.',
        criteria: [
            '👍 <b>견조한 회복세 (0.7% 이상):</b> 경제가 예상보다 강하게 성장하고 있음을 의미합니다.',
            '😐 <b>완만한 성장 (0.3% ~ 0.7%):</b> 경제가 안정적으로 성장하고 있음을 의미합니다.',
            '👎 <b>성장 둔화 우려 (0.3% 미만):</b> 경제 성장 동력이 약해지고 있음을 의미하며, 경기 둔화의 신호일 수 있습니다.'
        ]
    },
    export_growth: {
        title: '🇰🇷 수출 증가율',
        description: '대한민국 경제의 핵심 동력인 수출이 얼마나 늘고 줄었는지를 보여줍니다. 수출이 잘 되어야 기업들의 생산과 투자가 늘고, 일자리도 증가하는 선순환이 일어납니다.',
        criteria: [
            '📈 <b>플러스 전환 (2.0% 이상):</b> 수출이 강하게 회복되고 있으며, 경제 전반에 긍정적인 영향을 줍니다.',
            '📊 <b>소폭 개선 (0% ~ 2.0%):</b> 수출이 부진에서 벗어나 점차 개선되고 있음을 의미합니다.',
            '📉 <b>수출 부진 (0% 미만):</b> 수출이 감소하고 있어 기업 실적과 경제 성장에 부담을 줍니다.'
        ]
    },
    cpi: {
        title: '🇰🇷 소비자물가지수 (CPI)',
        description: '소비자가 일상생활에서 구매하는 상품과 서비스의 가격 변동을 나타내는 지표로, 인플레이션 수준을 측정하는 데 사용됩니다. 물가가 너무 가파르게 오르면 가계의 실질 소득이 줄어 소비가 위축될 수 있습니다.',
        criteria: [
            '😌 <b>물가 안정세 (3.0% 이하):</b> 물가가 관리 가능한 범위 내에서 안정적으로 움직이고 있습니다.',
            '😐 <b>인플레이션 둔화 (3.0% ~ 4.0%):</b> 물가 상승 압력이 다소 완화되었지만 여전히 높은 수준입니다.',
            '🔥 <b>물가 압력 지속 (4.0% 초과):</b> 높은 물가 상승으로 인해 가계 부담이 커지고 중앙은행의 금리 인상 가능성이 높아집니다.'
        ]
    },
    unemployment: {
        title: '🇰🇷 실업률',
        description: '경제활동인구 중에서 실업자가 차지하는 비율을 나타냅니다. 실업률이 낮다는 것은 고용 시장이 안정되어 있고, 가계 소득이 튼튼해져 소비가 늘어날 수 있다는 긍정적인 신호입니다.',
        criteria: [
            '💪 <b>완전고용 수준 (3.0% 이하):</b> 고용 시장이 매우 안정적이고 건강한 상태입니다.',
            '😥 <b>고용 시장 악화 (3.0% 초과):</b> 일자리를 찾는 사람이 늘어나고 있어 경기 둔화의 신호일 수 있습니다.'
        ]
    },
    base_rate: {
        title: '🇰🇷 기준금리',
        description: '중앙은행(한국은행)이 결정하는 정책 금리로, 시중 금리의 기준이 됩니다. 금리가 낮으면 시중에 돈이 많이 풀려 경기가 활성화되고(긍정), 높으면 긴축 효과로 경기가 둔화될 수 있습니다(부정).',
        criteria: [
            '💰 <b>완화적 통화정책 (2.5% 이하):</b> 경기 부양을 위해 금리를 낮은 수준으로 유지하고 있음을 의미합니다.',
            '⚖️ <b>중립적 금리 수준 (2.5% ~ 3.5%):</b> 경제가 안정적이라고 판단하여 금리를 중립적인 수준으로 유지하고 있음을 의미합니다.',
            '🔒 <b>긴축적 통화정책 (3.5% 초과):</b> 물가 안정을 위해 금리를 높은 수준으로 유지하고 있음을 의미합니다.'
        ]
    },
    exchange_rate: {
        title: '🇰🇷 원/달러 환율',
        description: '1달러를 사는 데 필요한 원화의 양입니다. 환율이 오르면(원화 약세) 수출 기업의 가격 경쟁력은 높아지지만, 수입 물가가 올라 국내 물가 상승 압력으로 작용합니다. 반대로 환율이 내리면(원화 강세) 수입 물가 안정에는 도움이 되지만 수출 기업의 실적에는 부담이 될 수 있습니다.',
        criteria: [
            '💵 <b>환율 안정 (1300원 이하):</b> 수출입 기업 모두에게 안정적인 환경을 제공합니다.',
            ' fluctuating <b>환율 변동성 확대 (1300원 ~ 1350원):</b> 시장의 불확실성이 커지고 있음을 의미합니다.',
            '💸 <b>원화 약세 심화 (1350원 초과):</b> 수입 물가 상승으로 인한 인플레이션 압력이 커지고, 외국인 자금 유출 우려가 높아집니다.'
        ]
    },
    vix: {
        title: '😱 VIX 지수 (공포 지수)',
        description: '시장의 불안감을 나타내는 지표입니다. 주식 시장의 변동성이 앞으로 30일간 얼마나 클지를 예측하며, 지수가 높을수록 시장 참여자들이 느끼는 공포와 불안감이 크다는 의미입니다.',
        criteria: [
            '😌 <b>시장 안정 (20 이하):</b> 투자 심리가 안정적이며, 시장의 불확실성이 낮은 상태입니다.',
            '😟 <b>불안 심리 존재 (20 ~ 30):</b> 시장에 불안 요소가 있어 변동성이 커질 수 있는 상태입니다.',
            '😱 <b>공포 심리 확산 (30 초과):</b> 시장에 대한 공포가 극에 달해 주가가 급락할 가능성이 높은 위험한 상태입니다.'
        ]
    },
    industrial_production: {
        title: '🇰🇷 산업생산지수',
        description: '국내 제조업, 광업 등 주요 산업의 생산 활동이 얼마나 활발한지를 보여줍니다. 이 지표가 상승하면 기업들의 생산이 활발하고 실물 경제가 튼튼하다는 신호로 해석됩니다.',
        criteria: [
            '🏭 <b>생산 활발 (1.0% 이상):</b> 제조업 경기가 확장 국면에 있음을 의미합니다.',
            '😐 <b>생산 보합 (0% ~ 1.0%):</b> 생산 활동이 정체되어 있음을 의미합니다.',
            '📉 <b>생산 위축 (0% 미만):</b> 생산 활동이 감소하고 있어 경기 둔화의 신호로 해석됩니다.'
        ]
    },
    consumer_sentiment: {
        title: '🇰🇷 소비자심리지수 (CSI)',
        description: '소비자들이 현재 경제 상황을 어떻게 느끼고 미래를 어떻게 전망하는지를 나타냅니다. 이 지수가 100을 넘으면 미래 경기를 긍정적으로 보는 사람이 더 많다는 뜻으로, 향후 소비가 늘어날 가능성이 높음을 시사합니다.',
        criteria: [
            '😊 <b>소비 심리 낙관 (100 이상):</b> 소비자들이 경기를 긍정적으로 보고 있어 향후 소비가 늘어날 가능성이 높습니다.',
            '😐 <b>소비 심리 중립 (90 ~ 100):</b> 소비자들이 경기 상황을 관망하고 있습니다.',
            '😟 <b>소비 심리 비관 (90 미만):</b> 소비자들이 경기를 부정적으로 보고 있어 지갑을 닫을 가능성이 높습니다.'
        ]
    },
    corp_bond_spread: {
        title: '🇰🇷 회사채 스프레드',
        description: '신용도가 낮은 회사채(BBB-)와 안전자산인 국고채 간의 금리 차이입니다. 이 스프레드가 커진다는 것은 기업들의 자금 조달이 어려워지고 부도 위험이 높아졌다고 시장이 판단하는 것을 의미합니다.',
        criteria: [
            '✅ <b>신용 위험 완화 (0.8%p 이하):</b> 기업들의 자금 조달 환경이 안정적입니다.',
            '⚠️ <b>신용 위험 보통 (0.8%p ~ 1.2%p):</b> 기업 신용 위험에 대한 경계감이 다소 있는 상태입니다.',
            '🚨 <b>신용 위험 증가 (1.2%p 초과):</b> 기업 부도 위험이 높아져 금융시장의 불안 요인이 될 수 있습니다.'
        ]
    },
    dollar_index: {
        title: '💲 달러 인덱스',
        description: '세계 주요 6개국 통화 대비 달러의 평균적인 가치를 보여줍니다. 달러 인덱스가 높으면 달러가 강세라는 뜻으로, 글로벌 자금이 안전자산인 달러로 몰려 신흥국 증시에는 부담이 될 수 있습니다.',
        criteria: [
            '💲 <b>달러 약세 (100 이하):</b> 달러 가치가 하락하여 신흥국 등 위험자산에 대한 투자 심리가 개선됩니다.',
            '💰 <b>달러 강세 (100 초과):</b> 달러 가치가 상승하여 안전자산 선호 심리가 강해집니다.'
        ]
    },
    wti_price: {
        title: '🛢️ WTI 유가',
        description: '서부 텍사스산 원유(WTI) 가격으로, 세계 경제의 혈액과도 같습니다. 유가는 전 세계 물가와 기업들의 생산 비용에 직접적인 영향을 미칩니다.',
        criteria: [
            '⛽ <b>유가 안정 (80달러 이하):</b> 물가 안정과 기업 생산 비용 절감에 긍정적입니다.',
            '🔺 <b>유가 상승 압력 (80달러 ~ 100달러):</b> 전 세계적으로 인플레이션 우려를 키우는 요인입니다.',
            '🔥 <b>고유가 부담 (100달러 초과):</b> 기업과 가계에 큰 부담을 주어 경기 둔화를 유발할 수 있습니다.'
        ]
    },
    kospi: {
        title: '🇰🇷 코스피 지수',
        description: '한국을 대표하는 주가 지수로, 국내 증권거래소에 상장된 기업들의 주가 움직임을 종합하여 표시합니다. 한국 경제의 전반적인 상황과 기업들의 실적을 반영하는 거울과도 같습니다.',
        criteria: [
            '📊 <b>주요 시장 지수:</b> 이 지수 자체는 분석 대상이기보다는 다른 지표들과 함께 종합적으로 해석하는 참고 자료입니다.'
        ]
    },
    producer_price_index: {
        title: '🇰🇷 생산자물가지수 (PPI)',
        description: '생산자가 시장에 공급하는 상품과 서비스의 가격 변동을 나타냅니다. 생산자물가는 보통 1~3개월의 시차를 두고 최종 소비자가 구매하는 소비자물가에 영향을 미치는 선행 지표 역할을 합니다.',
        criteria: [
            '😌 <b>생산자 물가 안정 (3.0% 이하):</b> 향후 소비자 물가 안정에 기여할 수 있는 긍정적인 신호입니다.',
            '🔺 <b>생산자 물가 부담 (3.0% 초과):</b> 기업들의 비용 부담이 커지고, 이는 결국 소비자 가격 인상으로 이어질 수 있습니다.'
        ]
    },
    sox_index: {
        title: '⚡️ 美 반도체 지수 (SOXX)',
        description: '미국 증시에 상장된 대표적인 반도체 기업 ETF(SOXX)의 가격입니다. 필라델피아 반도체 지수를 추종하며, 전 세계 반도체 산업의 업황을 가장 잘 보여주는 핵심 선행 지표로 활용됩니다.',
        criteria: [
            '📈 <b>상승:</b> 반도체 수요가 견조하고 업황이 긍정적임을 의미합니다.',
            '📉 <b>하락:</b> 반도체 수요 둔화 및 업황 악화 우려를 반영합니다.'
        ]
    },
    auto_sales: {
        title: '🚗 美 자동차 판매량',
        description: '미국 내에서 판매된 자동차 및 경트럭의 총량을 보여줍니다. 미국은 세계 최대의 자동차 시장 중 하나로, 이 데이터는 글로벌 자동차 수요와 소비 경기를 가늠하는 척도가 됩니다.',
        criteria: [
            '📈 <b>증가:</b> 소비 심리가 살아나고 자동차 수요가 강함을 의미합니다.',
            '📉 <b>감소:</b> 소비자들이 지갑을 닫고 있으며, 자동차 수요가 둔화되고 있음을 의미합니다.'
        ]
    },
    pharma_index: {
        title: '💊 美 제약업 생산자물가',
        description: '미국의 제약 및 의약품 제조업체의 생산자 물가 변동을 나타냅니다. 제약/바이오 산업은 전통적으로 경기가 좋지 않을 때도 꾸준한 수요가 발생하는 경기 방어적 성격을 가집니다.',
        criteria: [
            '📈 <b>물가 안정:</b> 생산 비용이 안정되어 기업 수익성에 긍정적입니다.',
            '📉 <b>물가 상승:</b> 생산 비용 증가로 기업 수익성에 부담이 될 수 있습니다.'
        ]
    },
    retail_sales: {
        title: '🛒 美 소매 판매',
        description: '미국의 전반적인 소비 활동을 나타내는 핵심 지표입니다. 소매 판매가 증가하면 경제가 활발하게 움직이고 있음을 의미하며, 기업 실적에도 긍정적인 영향을 줍니다.',
        criteria: [
            '📈 <b>판매 호조:</b> 소비가 강하게 살아나고 있어 경기 확장의 신호입니다.',
            '📉 <b>판매 부진:</b> 소비 심리가 위축되고 있어 경기 둔화의 신호일 수 있습니다.'
        ]
    },
    home_price_index: {
        title: '🏠 美 주택 가격 지수',
        description: 'S&P/Case-Shiller 미국 전국 주택 가격 지수로, 미국 주택 시장의 건강 상태를 보여줍니다. 주택 가격 상승은 소비자의 자산 가치를 높여 소비 심리를 개선하는 효과가 있습니다.',
        criteria: [
            '📈 <b>가격 상승:</b> 주택 시장이 활성화되고 있으며, 이는 긍정적인 자산 효과로 이어질 수 있습니다.',
            '📉 <b>가격 하락:</b> 주택 시장이 둔화되고 있으며, 소비 심리에 부정적인 영향을 줄 수 있습니다.'
        ]
    }
};

document.addEventListener('DOMContentLoaded', main);

async function main() {
    if (API_KEYS.FRED.includes('여기에') || API_KEYS.ECOS.includes('여기에')) {
        alert('JavaScript 코드 상단에 API 키를 먼저 입력해주세요.');
        return;
    }
    
    setupModal();
    renderInitialPlaceholders();

    try {
        const [macroData, sectorData] = await Promise.all([
            fetchAllMacroData(),
            fetchAllSectorData()
        ]);
        
        const allIndicators = [...macroData, ...sectorData];
        const analyzedIndicators = analyzeIndicators(allIndicators);
        
        const marketOutlook = getMarketOutlook(analyzedIndicators);
        const sectorOutlook = getSectorOutlook(analyzedIndicators);

        renderDashboard(analyzedIndicators, marketOutlook, sectorOutlook);

    } catch (error) {
        console.error("데이터 로딩 실패:", error);
        document.getElementById('update-time').innerText = "데이터 로딩에 실패했습니다. API 키 또는 네트워크 상태를 확인해주세요.";
    }
}

async function fetchAllMacroData() {
    const [yieldData, additionalFredData, koreanIndicators] = await Promise.all([
        fetchYieldSpread(),
        fetchAdditionalFredData(),
        fetchAllKoreanData()
    ]);
    return [yieldData, ...additionalFredData, ...koreanIndicators];
}

async function fetchYieldSpread() {
    const fredUrl10Y = `https://api.stlouisfed.org/fred/series/observations?series_id=DGS10&api_key=${API_KEYS.FRED}&file_type=json&sort_order=desc&limit=1`;
    const fredUrl2Y = `https://api.stlouisfed.org/fred/series/observations?series_id=DGS2&api_key=${API_KEYS.FRED}&file_type=json&sort_order=desc&limit=1`;
    const [res10Y, res2Y] = await Promise.all([
        fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(fredUrl10Y)}`),
        fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(fredUrl2Y)}`)
    ]);
    const data10Y = await res10Y.json();
    const data2Y = await res2Y.json();
    if (!data10Y.observations || !data2Y.observations || data10Y.observations.length === 0 || data2Y.observations.length === 0) throw new Error("FRED 금리 데이터 로딩 실패");
    const spread = parseFloat(data10Y.observations[0].value) - parseFloat(data2Y.observations[0].value);
    return { id: "yield_spread", name: "🇺🇸 장단기 금리차", value: parseFloat(spread.toFixed(2)), unit: "%p", date: data10Y.observations[0].date.substring(5) };
}

async function fetchAdditionalFredData() {
    const series = { vix: 'VIXCLS', dollarIndex: 'DTWEXBGS', wti: 'MCOILWTICO' };
    const urls = Object.values(series).map(id => `https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${API_KEYS.FRED}&file_type=json&sort_order=desc&limit=1`);
    const [vixData, dollarData, wtiData] = await Promise.all(urls.map(url => fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(url)}`).then(res => res.json())));
    
    const format = (data, id, name, unit) => {
        const obs = data.observations?.[0];
        return { id, name, value: obs ? parseFloat(obs.value) : 'N/A', unit, date: obs ? obs.date.substring(5) : '없음' };
    };
    return [ format(vixData, 'vix', '😱 VIX 지수', ''), format(dollarData, 'dollar_index', '💲 달러 인덱스', ''), format(wtiData, 'wti_price', '🛢️ WTI 유가', '$/bbl') ];
}

async function fetchAllKoreanData() {
    const ecosApiUrl = `https://ecos.bok.or.kr/api/KeyStatisticList/${API_KEYS.ECOS}/json/kr/1/100`;
    const response = await fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(ecosApiUrl)}`);
    const data = await response.json();
    if (!data.KeyStatisticList?.row) throw new Error("한국은행 데이터 로딩 실패");
    
    const allStats = data.KeyStatisticList.row;
    const mapping = {
        base_rate: { name: '🇰🇷 기준금리', keywords: ['기준금리'] },
        exchange_rate: { name: '🇰🇷 원/달러 환율', keywords: ['원/달러'] },
        industrial_production: { name: '🇰🇷 산업생산지수', keywords: ['산업생산지수'] },
        consumer_sentiment: { name: '🇰🇷 소비자심리지수', keywords: ['소비자동향조사', '소비자심리지수'] },
        corp_bond_spread: { name: '🇰🇷 회사채 스프레드', keywords: ['회사채', '스프레드'] },
        kospi: { name: '🇰🇷 코스피', keywords: ['KOSPI'] },
        producer_price_index: { name: '🇰🇷 생산자물가지수', keywords: ['생산자물가지수'] },
        gdp_growth: { name: '🇰🇷 GDP 성장률', keywords: ['GDP', '성장률', '전기대비'] },
        export_growth: { name: '🇰🇷 수출 증가율', keywords: ['수출', '증감률'] },
        cpi: { name: '🇰🇷 소비자물가지수', keywords: ['소비자물가지수'] },
        unemployment: { name: '🇰🇷 실업률', keywords: ['실업률'] }
    };
    
    const found = {};
    allStats.forEach(stat => {
        for (const [key, value] of Object.entries(mapping)) {
            if (!found[key] && value.keywords.every(kw => stat.KEYSTAT_NAME.includes(kw))) {
                found[key] = {
                    id: key, name: value.name, value: parseFloat(stat.DATA_VALUE),
                    unit: stat.UNIT_NAME, date: stat.TIME?.substring(4, 6) + '월' || '최신'
                };
            }
        }
    });
    return Object.values(found);
}

async function fetchAllSectorData() {
    const series = {
        sox_index: 'NASDAQSOX', // PHLX Semiconductor Index
        pharma_index: 'PCU325412325412', // Producer Price Index by Industry: Pharmaceutical Preparation Manufacturing
        auto_sales: 'TOTALSA',
        retail_sales: 'MRTSSM44000USS',
        home_price_index: 'CSUSHPINSA'
    };
    
    const urls = Object.values(series).map(id => `https://api.stlouisfed.org/fred/series/observations?series_id=${id}&api_key=${API_KEYS.FRED}&file_type=json&sort_order=desc&limit=1`);
    const [soxData, pharmaData, autoData, retailData, homeData] = await Promise.all(urls.map(url => fetch(`/.netlify/functions/proxy?targetUrl=${encodeURIComponent(url)}`).then(res => res.json())));
    
    const format = (data, id, name, unit) => {
        const obs = data.observations?.[0];
        return { id, name, value: obs ? parseFloat(obs.value) : 'N/A', unit, date: obs ? obs.date.substring(5) : '없음' };
    };
    return [
        format(soxData, 'sox_index', '⚡️ PHLX 반도체 지수 (SOX)', ''),
        format(pharmaData, 'pharma_index', '💊 美 제약업 생산자물가', ''),
        format(autoData, 'auto_sales', '🚗 美 자동차 판매량', 'M'),
        format(retailData, 'retail_sales', '🛒 美 소매 판매', '$'),
        format(homeData, 'home_price_index', '🏠 美 주택 가격 지수', '')
    ];
}


function analyzeIndicators(indicators) {
    const weights = {
        yield_spread: 15, vix: 15, gdp_growth: 10, export_growth: 10, industrial_production: 8,
        corp_bond_spread: 8, cpi: 7, dollar_index: 6, wti_price: 5, consumer_sentiment: 5,
        base_rate: 4, unemployment: 4, exchange_rate: 3, producer_price_index: 2, kospi: 0,
        sox_index: 0, auto_sales: 0, pharma_index: 0, retail_sales: 0, home_price_index: 0
    };

    return indicators.map(indicator => {
        let analysis = { weight: weights[indicator.id] || 0 };
        if (typeof indicator.value !== 'number' || isNaN(indicator.value)) {
             return { ...indicator, ...analysis, status: 'negative', score: 0, text: '데이터 없음', icon: '❌' };
        }
        switch (indicator.id) {
            case 'yield_spread':
                if (indicator.value < -0.1) analysis = { ...analysis, status: 'negative', score: -2, text: '경기 침체 우려', icon: '🚨' };
                else if (indicator.value < 0) analysis = { ...analysis, status: 'neutral', score: 0, text: '역전폭 축소', icon: '⚠️' };
                else analysis = { ...analysis, status: 'positive', score: 2, text: '정상 범위', icon: '✅' };
                break;
            case 'vix':
                if (indicator.value <= 20) analysis = { ...analysis, status: 'positive', score: 2, text: '시장 안정', icon: '😌' };
                else if (indicator.value <= 30) analysis = { ...analysis, status: 'neutral', score: 0, text: '불안 심리 존재', icon: '😟' };
                else analysis = { ...analysis, status: 'negative', score: -2, text: '공포 심리 확산', icon: '😱' };
                break;
            case 'gdp_growth':
                if (indicator.value >= 0.7) analysis = { ...analysis, status: 'positive', score: 2, text: '견조한 회복세', icon: '👍' };
                else if (indicator.value >= 0.3) analysis = { ...analysis, status: 'neutral', score: 0, text: '완만한 성장', icon: '😐' };
                else analysis = { ...analysis, status: 'negative', score: -2, text: '성장 둔화 우려', icon: '👎' };
                break;
            case 'export_growth':
                if (indicator.value > 2.0) analysis = { ...analysis, status: 'positive', score: 2, text: '플러스 전환', icon: '📈' };
                else if (indicator.value >= 0) analysis = { ...analysis, status: 'neutral', score: 0, text: '소폭 개선', icon: '📊' };
                else analysis = { ...analysis, status: 'negative', score: -2, text: '수출 부진', icon: '📉' };
                break;
            case 'industrial_production':
                if (indicator.value > 1.0) analysis = { ...analysis, status: 'positive', score: 2, text: '생산 활발', icon: '🏭' };
                else if (indicator.value >= 0) analysis = { ...analysis, status: 'neutral', score: 0, text: '생산 보합', icon: '😐' };
                else analysis = { ...analysis, status: 'negative', score: -2, text: '생산 위축', icon: '📉' };
                break;
            case 'cpi':
                if (indicator.value <= 3.0) analysis = { ...analysis, status: 'positive', score: 1, text: '물가 안정세', icon: '😌' };
                else if (indicator.value <= 4.0) analysis = { ...analysis, status: 'neutral', score: 0, text: '인플레이션 둔화', icon: '😐' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '물가 압력 지속', icon: '🔥' };
                break;
            case 'unemployment':
                if (indicator.value <= 3.0) analysis = { ...analysis, status: 'positive', score: 1, text: '완전고용 수준', icon: '💪' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '고용 시장 악화', icon: '😥' };
                break;
             case 'base_rate':
                if (indicator.value <= 2.5) analysis = { ...analysis, status: 'positive', score: 1, text: '완화적 통화정책', icon: '💰' };
                else if (indicator.value <= 3.5) analysis = { ...analysis, status: 'neutral', score: 0, text: '중립적 금리 수준', icon: '⚖️' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '긴축적 통화정책', icon: '🔒' };
                break;
            case 'exchange_rate':
                if (indicator.value <= 1300) analysis = { ...analysis, status: 'positive', score: 1, text: '환율 안정', icon: '💵' };
                else if (indicator.value <= 1350) analysis = { ...analysis, status: 'neutral', score: 0, text: '환율 변동성 확대', icon: ' fluctuating' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '원화 약세 심화', icon: '💸' };
                break;
            case 'consumer_sentiment':
                if (indicator.value >= 100) analysis = { ...analysis, status: 'positive', score: 1, text: '소비 심리 낙관', icon: '😊' };
                else if (indicator.value >= 90) analysis = { ...analysis, status: 'neutral', score: 0, text: '소비 심리 중립', icon: '😐' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '소비 심리 비관', icon: '😟' };
                break;
            case 'corp_bond_spread':
                if (indicator.value <= 0.8) analysis = { ...analysis, status: 'positive', score: 1, text: '신용 위험 완화', icon: '✅' };
                else if (indicator.value <= 1.2) analysis = { ...analysis, status: 'neutral', score: 0, text: '신용 위험 보통', icon: '⚠️' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '신용 위험 증가', icon: '🚨' };
                break;
            case 'dollar_index':
                if (indicator.value <= 100) analysis = { ...analysis, status: 'positive', score: 1, text: '달러 약세', icon: '💲' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '달러 강세', icon: '💰' };
                break;
            case 'wti_price':
                if (indicator.value <= 80) analysis = { ...analysis, status: 'positive', score: 1, text: '유가 안정', icon: '⛽' };
                else if (indicator.value <= 100) analysis = { ...analysis, status: 'neutral', score: 0, text: '유가 상승 압력', icon: '🔺' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '고유가 부담', icon: '🔥' };
                break;
            case 'producer_price_index':
                if (indicator.value <= 3.0) analysis = { ...analysis, status: 'positive', score: 1, text: '생산자 물가 안정', icon: '😌' };
                else analysis = { ...analysis, status: 'negative', score: -1, text: '생산자 물가 부담', icon: '🔺' };
                break;
            case 'kospi':
                analysis = { ...analysis, status: 'neutral', score: 0, text: '주요 시장 지수', icon: '📊' };
                break;
            case 'sox_index':
                 analysis = { ...analysis, status: 'neutral', score: 0, text: '반도체 업황 지수', icon: '💡' };
                 break;
            case 'auto_sales':
                 if (indicator.value >= 16) analysis = { ...analysis, status: 'positive', score: 1, text: '자동차 수요 견조', icon: '👍' };
                 else if (indicator.value >= 14) analysis = { ...analysis, status: 'neutral', score: 0, text: '자동차 수요 보통', icon: '😐' };
                 else analysis = { ...analysis, status: 'negative', score: -1, text: '자동차 수요 둔화', icon: '👎' };
                 break;
            case 'pharma_index':
                 analysis = { ...analysis, status: 'neutral', score: 0, text: '제약/바이오 업황 지수', icon: '🔬' };
                 break;
            case 'retail_sales':
                analysis = { ...analysis, status: 'neutral', score: 0, text: '소비 경기 지표', icon: '🛒' };
                break;
            case 'home_price_index':
                analysis = { ...analysis, status: 'neutral', score: 0, text: '자산 시장 지표', icon: '🏠' };
                break;
            default: analysis = { ...analysis, status: 'neutral', score: 0, text: '분석 중', icon: '📊' };
        }
        return { ...indicator, ...analysis };
    });
}

function getMarketOutlook(analyzedIndicators) {
    let totalWeightedScore = 0;
    let totalPossibleScore = 0;

    analyzedIndicators.forEach(indicator => {
        if (typeof indicator.score === 'number' && indicator.weight > 0) {
            totalWeightedScore += indicator.score * indicator.weight;
            const maxScore = (indicator.id === 'yield_spread' || indicator.id === 'vix' || indicator.id === 'gdp_growth' || indicator.id === 'export_growth' || indicator.id === 'industrial_production') ? 2 : 1;
            totalPossibleScore += maxScore * indicator.weight;
        }
    });
    
    const normalizedScore = 50 + 50 * (totalWeightedScore / totalPossibleScore);

    if (normalizedScore > 65) return { status: 'positive', signal: '📈', title: `상승 기대 (점수: ${normalizedScore.toFixed(1)})`, analysis: "다수의 핵심 경제 지표가 긍정적인 신호를 보내고 있습니다. 경기 확장, 물가 안정, 위험자산 선호 심리가 복합적으로 나타나며 투자 환경이 우호적일 가능성이 높습니다." };
    if (normalizedScore < 35) return { status: 'negative', signal: '📉', title: `하락 우려 (점수: ${normalizedScore.toFixed(1)})`, analysis: "경기 침체 또는 둔화에 대한 우려가 커지고 있습니다. 장단기 금리차, VIX 지수 등 주요 선행지표가 부정적인 신호를 보내고 있어 보수적인 접근이 필요합니다." };
    return { status: 'neutral', signal: '😐', title: `중립 / 혼조 (점수: ${normalizedScore.toFixed(1)})`, analysis: "긍정적 요인과 부정적 요인이 혼재되어 시장의 방향성이 불분명합니다. 향후 발표될 기업 실적이나 주요 정책 변화에 따라 시장의 방향이 결정될 가능성이 높습니다." };
}

function getSectorOutlook(analyzedIndicators) {
    const find = (id) => analyzedIndicators.find(i => i.id === id) || {};

    const exchange_rate = find('exchange_rate');
    let electronicsOutlook = { status: 'neutral', text: '중립적', reason: '글로벌 수요와 환율 효과가 혼재되어 있습니다.'};
    if (exchange_rate.score >= 0) {
        electronicsOutlook = { status: 'positive', text: '긍정적', reason: '반도체 업황 개선과 우호적인 환율 환경으로 실적 개선 기대감이 높습니다.'};
    } else {
        electronicsOutlook = { status: 'neutral', text: '중립적', reason: '반도체 업황은 긍정적이나, 원화 강세가 수출 기업의 수익성을 일부 상쇄합니다.'};
    }

    const auto = find('auto_sales');
    const wti = find('wti_price');
    let autoOutlook = { status: 'neutral', text: '중립적', reason: '판매량과 유가 변동을 주시해야 합니다.'};
    if (auto.score > 0 && wti.score > 0) {
        autoOutlook = { status: 'positive', text: '긍정적', reason: '견조한 판매량과 유가 안정으로 소비 심리가 개선될 가능성이 높습니다.'};
    } else if (auto.score < 0) {
         autoOutlook = { status: 'negative', text: '부정적', reason: '자동차 수요 둔화 시그널이 나타나고 있습니다.'};
    } else if (wti.score < 0) {
        autoOutlook = { status: 'neutral', text: '중립적', reason: '판매량은 양호하나, 고유가가 소비자의 구매 부담을 높일 수 있습니다.'};
    }

    const vix = find('vix');
    let pharmaOutlook = { status: 'neutral', text: '중립적', reason: '경기 방어적 성격과 성장 기대감이 공존합니다.'};
    if (vix.score < 0) {
        pharmaOutlook = { status: 'positive', text: '긍정적', reason: '시장 변동성이 커질 때, 경기 방어주로서의 매력이 부각될 수 있습니다.'};
    } else if (vix.score > 0) {
         pharmaOutlook = { status: 'neutral', text: '중립적', reason: '시장이 안정적일 때는 성장주 대비 매력도가 낮아질 수 있습니다.'};
    }

    // 신규 섹터 전망 로직 추가
    const retail = find('retail_sales');
    let retailOutlook = { status: 'neutral', text: '중립적', reason: '소비자 심리와 고용 지표를 함께 고려해야 합니다.' };
    if (retail.value > 0) { // 단순하게 양수이면 긍정적으로 판단 (실제로는 더 복잡한 로직 필요)
        retailOutlook = { status: 'positive', text: '긍정적', reason: '견조한 소매 판매는 내수 경기 회복의 긍정적인 신호입니다.'};
    } else {
        retailOutlook = { status: 'negative', text: '부정적', reason: '소매 판매 감소는 소비 심리 위축 및 경기 둔화 우려를 키웁니다.'};
    }
    
    const home = find('home_price_index');
    let constructionOutlook = { status: 'neutral', text: '중립적', reason: '금리 변동에 민감하며, 정부 정책의 영향을 많이 받습니다.' };
    // 최근 데이터가 이전 데이터보다 높을 때 긍정적이라고 가정
    if (home.value > 300) { // 임의의 기준
        constructionOutlook = { status: 'positive', text: '긍정적', reason: '주택 가격 상승은 자산 효과를 통해 소비를 촉진하고 건설 경기에 긍정적입니다.'};
    } else {
        constructionOutlook = { status: 'neutral', text: '중립적', reason: '주택 가격 안정세는 시장의 불확실성을 반영합니다.'};
    }


    return { electronics: electronicsOutlook, auto: autoOutlook, pharma: pharmaOutlook, retail: retailOutlook, construction: constructionOutlook };
}

function renderInitialPlaceholders() {
    const ids = Object.values(indicatorDetails).map(detail => detail.title);
    const grid = document.getElementById('indicator-grid');
    grid.innerHTML = ids.map(name => `<div class="indicator-card"><p class="loading-text">${name}<br>Loading...</p></div>`).join('');
    
    const sectorGrid = document.getElementById('sector-outlook-grid');
    sectorGrid.innerHTML = `
        <div class="sector-card"><p class="loading-text">전기/전자 분석 중...</p></div>
        <div class="sector-card"><p class="loading-text">자동차 분석 중...</p></div>
        <div class="sector-card"><p class="loading-text">의약/바이오 분석 중...</p></div>
        <div class="sector-card"><p class="loading-text">유통/소비재 분석 중...</p></div>
        <div class="sector-card"><p class="loading-text">건설/부동산 분석 중...</p></div>
    `;
}

function renderDashboard(analyzedIndicators, marketOutlook, sectorOutlook) {
    document.getElementById('update-time').innerText = `마지막 업데이트: ${new Date().toLocaleString('ko-KR')}`;
    
    const outlookSection = document.getElementById('outlook-section');
    outlookSection.className = `${marketOutlook.status}-bg`;
    outlookSection.innerHTML = `
        <div class="outlook-signal">${marketOutlook.signal}</div>
        <h3 class="outlook-title ${marketOutlook.status}-text">${marketOutlook.title}</h3>
        <p class="outlook-analysis">${marketOutlook.analysis}</p>
    `;

    const sectorGrid = document.getElementById('sector-outlook-grid');
    sectorGrid.innerHTML = `
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">⚡️</span>전기/전자</h4>
            <p class="sector-outlook ${sectorOutlook.electronics.status}-text">${sectorOutlook.electronics.text}</p>
            <p class="sector-reason">${sectorOutlook.electronics.reason}</p>
        </div>
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">🚗</span>자동차</h4>
            <p class="sector-outlook ${sectorOutlook.auto.status}-text">${sectorOutlook.auto.text}</p>
            <p class="sector-reason">${sectorOutlook.auto.reason}</p>
        </div>
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">💊</span>의약/바이오</h4>
            <p class="sector-outlook ${sectorOutlook.pharma.status}-text">${sectorOutlook.pharma.text}</p>
            <p class="sector-reason">${sectorOutlook.pharma.reason}</p>
        </div>
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">🛒</span>유통/소비재</h4>
            <p class="sector-outlook ${sectorOutlook.retail.status}-text">${sectorOutlook.retail.text}</p>
            <p class="sector-reason">${sectorOutlook.retail.reason}</p>
        </div>
        <div class="sector-card">
            <h4 class="sector-title"><span class="sector-icon">🏠</span>건설/부동산</h4>
            <p class="sector-outlook ${sectorOutlook.construction.status}-text">${sectorOutlook.construction.text}</p>
            <p class="sector-reason">${sectorOutlook.construction.reason}</p>
        </div>
    `;

    const indicatorGrid = document.getElementById('indicator-grid');
    indicatorGrid.innerHTML = '';
    
    const totalWeight = analyzedIndicators.reduce((sum, ind) => sum + (ind.weight > 0 ? ind.weight : 0), 0);
    analyzedIndicators.sort((a, b) => (b.weight || 0) - (a.weight || 0));
    
    analyzedIndicators.forEach(indicator => {
        if (!indicator.id) return;
        const impactRatio = totalWeight > 0 && indicator.weight > 0 ? ((indicator.weight / totalWeight) * 100).toFixed(1) : 0;
        
        const card = document.createElement('div');
        card.className = 'indicator-card';
        if (indicator.status === 'negative') {
            card.classList.add('card-negative-bg');
        }

        const valueText = (typeof indicator.value === 'number' && !isNaN(indicator.value)) 
            ? `${indicator.value.toLocaleString()}${indicator.unit || ''}` 
            : `<span class="loading-text">${indicator.value}</span>`;
            
        card.innerHTML = `
            <div>
                <div class="indicator-card-header">
                    <h4>${indicator.name}<br><span class="date">(${indicator.date})</span></h4>
                </div>
                <p class="indicator-value">${valueText}</p>
                <div class="indicator-status">
                    <span class="status-icon">${indicator.icon}</span>
                    <span class="status-text ${indicator.status}-icon">${indicator.text}</span>
                </div>
            </div>
            <div class="card-footer">
                ${impactRatio > 0 ? `<span class="impact-ratio">영향력 ${impactRatio}%</span>` : ''}
                <button class="details-btn" onclick="showModal('${indicator.id}')">자세히 보기</button>
            </div>`;
        indicatorGrid.appendChild(card);
    });
}

function setupModal() {
    const modal = document.getElementById('modal');
    const closeBtn = document.getElementsByClassName('close-btn')[0];
    closeBtn.onclick = () => { modal.style.display = 'none'; };
    window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };
}

function showModal(indicatorId) {
    const details = indicatorDetails[indicatorId];
    if (!details) return;
    document.getElementById('modal-title').innerHTML = details.title;
    document.getElementById('modal-description').innerHTML = details.description;
    const criteriaList = document.getElementById('modal-criteria');
    criteriaList.innerHTML = details.criteria.map(item => `<li>${item}</li>`).join('');
    document.getElementById('modal').style.display = 'block';
}

</script>
</body>
</html>
